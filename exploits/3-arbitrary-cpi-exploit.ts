/**
 * Standalone Exploit Demonstration: Arbitrary CPI
 *
 * This script demonstrates how unvalidated cross-program invocations
 * allow attackers to hijack protocol authority.
 */

import { Keypair, PublicKey } from "@solana/web3.js";

async function demonstrateExploit() {
  console.log("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  EXPLOIT: Arbitrary CPI");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

  const protocolProgram = Keypair.generate().publicKey;
  const protocolAuthority = Keypair.generate().publicKey;
  const tokenProgram = new PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
  const maliciousProgram = Keypair.generate().publicKey;
  const attacker = Keypair.generate().publicKey;

  console.log("ğŸ“‹ Initial Setup:");
  console.log("   Protocol Program:    ", protocolProgram.toBase58());
  console.log("   Protocol Authority:  ", protocolAuthority.toBase58());
  console.log("   Real Token Program:  ", tokenProgram.toBase58());
  console.log("   Malicious Program:   ", maliciousProgram.toBase58());
  console.log("   Attacker:            ", attacker.toBase58());
  console.log("");

  console.log("Step 1: Understanding the vulnerability");
  console.log("   Protocol has 'execute_callback' function that:");
  console.log("   â€¢ Accepts user-provided program_id parameter");
  console.log("   â€¢ Invokes that program via CPI");
  console.log("   â€¢ Passes protocol authority as signer!");
  console.log("   âŒ No validation on target program ID");
  console.log("");

  console.log("Step 2: Attacker deploys malicious program");
  console.log("   Malicious program contains:");
  console.log("");
  console.log("   fn steal_funds(authority: Signer) {");
  console.log("       // Authority signature received from CPI!");
  console.log("       transfer_all(authority, attacker);");
  console.log("   }");
  console.log("");
  console.log("   âœ… Malicious program deployed");
  console.log("");

  console.log("Step 3: ğŸš¨ ATTACK - Invoke malicious program");
  console.log("   Attack execution:");
  console.log("   1. Call protocol's execute_callback function");
  console.log("   2. Pass malicious_program_id as target");
  console.log("   3. Protocol invokes malicious program");
  console.log("   4. Malicious program receives authority signature!");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  VULNERABLE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âš ï¸  EXPLOIT SUCCESSFUL!");
  console.log("");
  console.log("   CPI Flow:");
  console.log("   Protocol â†’ Malicious Program");
  console.log("   Authority: âœ… Signed (passed from protocol!)");
  console.log("");
  console.log("   Malicious program execution:");
  console.log("   ğŸ’€ Received authority signature");
  console.log("   ğŸ’€ Drained all protocol-controlled funds");
  console.log("   ğŸ’€ Transferred to attacker");
  console.log("");
  console.log("   Result:");
  console.log("   Protocol balance: 0 SOL (was 1,000,000 SOL)");
  console.log("   Attacker balance: 1,000,000 SOL");
  console.log("");

  console.log("   Why it worked:");
  console.log("   âŒ User controls target program ID");
  console.log("   âŒ No whitelist of allowed programs");
  console.log("   âŒ Authority signature passed to unknown program");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  SECURE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âœ… ATTACK BLOCKED!");
  console.log("");
  console.log("   âœ… Transaction rejected");
  console.log("   âœ… Error: UnauthorizedProgram");
  console.log("   âœ… Protocol funds safe");
  console.log("");

  console.log("   How it was fixed:");
  console.log("   âœ… Hardcoded whitelist of allowed programs");
  console.log("   âœ… Runtime validation: target == TOKEN_PROGRAM_ID");
  console.log("   âœ… Only trusted programs receive authority");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  IMPACT SUMMARY");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("  Severity: ğŸ”´ CRITICAL");
  console.log("  Frequency: Moderate (10-15% of programs)");
  console.log("");
  console.log("  Consequences:");
  console.log("  â€¢ Complete protocol compromise");
  console.log("  â€¢ Total loss of all protocol-controlled funds");
  console.log("  â€¢ Authority hijacking");
  console.log("");

  console.log("  Prevention:");
  console.log("  âœ… Hardcode allowed program IDs");
  console.log("  âœ… Use Program<'info, T> type for validation");
  console.log("  âœ… Avoid user-controlled CPI targets");
  console.log("  âœ… Use enum for allowed operations instead");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

demonstrateExploit().catch((err) => {
  console.error("Error:", err);
  process.exit(1);
});
