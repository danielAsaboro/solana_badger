/**
 * Standalone Exploit Demonstration: PDA Sharing
 *
 * This script demonstrates how insufficient PDA seed derivation
 * allows cross-user fund theft.
 */

import { Keypair, PublicKey } from "@solana/web3.js";

async function demonstrateExploit() {
  console.log("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  EXPLOIT: PDA Sharing");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

  const alice = Keypair.generate();
  const bob = Keypair.generate();
  const programId = Keypair.generate().publicKey;

  // Vulnerable: global PDA shared by all users
  const globalPoolPda = PublicKey.findProgramAddressSync(
    [Buffer.from("pool")],
    programId
  )[0];

  // Secure: user-specific PDAs
  const alicePoolPda = PublicKey.findProgramAddressSync(
    [Buffer.from("pool"), alice.publicKey.toBuffer()],
    programId
  )[0];

  const bobPoolPda = PublicKey.findProgramAddressSync(
    [Buffer.from("pool"), bob.publicKey.toBuffer()],
    programId
  )[0];

  console.log("ðŸ“‹ Initial Setup:");
  console.log("   Alice:          ", alice.publicKey.toBase58());
  console.log("   Bob:            ", bob.publicKey.toBase58());
  console.log("   Program ID:     ", programId.toBase58());
  console.log("");
  console.log("   Vulnerable (Global PDA):");
  console.log("   Seeds: [b\"pool\"]");
  console.log("   PDA:   ", globalPoolPda.toBase58());
  console.log("");
  console.log("   Secure (User-specific PDAs):");
  console.log("   Alice seeds: [b\"pool\", alice.pubkey]");
  console.log("   Alice PDA:   ", alicePoolPda.toBase58());
  console.log("   Bob seeds:   [b\"pool\", bob.pubkey]");
  console.log("   Bob PDA:     ", bobPoolPda.toBase58());
  console.log("");

  console.log("Step 1: Alice deposits to vulnerable pool");
  console.log("   Alice deposits: 100 SOL");
  console.log("   Pool balance: 100 SOL");
  console.log("   Pool PDA: " + globalPoolPda.toBase58());
  console.log("   âœ… Deposit successful");
  console.log("");

  console.log("Step 2: Bob deposits to the SAME pool");
  console.log("   Bob deposits: 50 SOL");
  console.log("   Pool balance: 150 SOL (Alice's 100 + Bob's 50)");
  console.log("   Pool PDA: " + globalPoolPda.toBase58() + " (SAME!)");
  console.log("   âœ… Deposit successful");
  console.log("");

  console.log("Step 3: ðŸš¨ ATTACK - Alice withdraws more than she deposited");
  console.log("   Vulnerability: Single shared pool for all users");
  console.log("");
  console.log("   Attack execution:");
  console.log("   1. Alice calls withdraw(150 SOL)");
  console.log("   2. Program checks: pool.balance >= 150? YES (150 >= 150)");
  console.log("   3. Program deducts: pool.balance -= 150");
  console.log("   4. Alice receives 150 SOL");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  VULNERABLE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âš ï¸  EXPLOIT SUCCESSFUL!");
  console.log("");
  console.log("   Before Alice's withdrawal:");
  console.log("   Pool balance:   150 SOL");
  console.log("   Alice balance:  0 SOL");
  console.log("   Bob balance:    0 SOL");
  console.log("");
  console.log("   After Alice's withdrawal:");
  console.log("   Pool balance:   0 SOL   (was 150 SOL)");
  console.log("   Alice balance:  150 SOL (deposited 100, withdrew 150!)");
  console.log("   Bob balance:    0 SOL   (can't withdraw his 50!)");
  console.log("");
  console.log("   ðŸ’€ Alice withdrew 150 SOL (her 100 + Bob's 50)");
  console.log("   ðŸ’€ Bob's 50 SOL stolen");
  console.log("   ðŸ’€ Pool drained, Bob gets nothing");
  console.log("");

  console.log("   Why it worked:");
  console.log("   âŒ PDA seeds: [b\"pool\"] - NO user isolation");
  console.log("   âŒ All users share the same pool account");
  console.log("   âŒ No per-user balance tracking");
  console.log("   âŒ First-come-first-served withdrawal");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  SECURE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âœ… ATTACK PREVENTED!");
  console.log("");
  console.log("   Alice's pool:");
  console.log("   PDA: " + alicePoolPda.toBase58());
  console.log("   Balance: 100 SOL (only Alice's deposit)");
  console.log("");
  console.log("   Bob's pool:");
  console.log("   PDA: " + bobPoolPda.toBase58());
  console.log("   Balance: 50 SOL (only Bob's deposit)");
  console.log("");
  console.log("   When Alice tries to withdraw 150 SOL:");
  console.log("   âœ… Check: alice_pool.balance >= 150?");
  console.log("   âœ… NO (100 < 150)");
  console.log("   âœ… Transaction rejected: InsufficientFunds");
  console.log("");

  console.log("   How it was fixed:");
  console.log("   âœ… User-specific PDA seeds: [b\"pool\", user.key()]");
  console.log("   âœ… Each user has isolated pool account");
  console.log("   âœ… Can only withdraw own funds");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  IMPACT SUMMARY");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("  Severity: ðŸŸ¡ MEDIUM-HIGH");
  console.log("  Frequency: Moderate");
  console.log("");
  console.log("  Consequences:");
  console.log("  â€¢ Cross-user fund theft");
  console.log("  â€¢ Race condition exploits");
  console.log("  â€¢ Bank run scenarios");
  console.log("");

  console.log("  When shared PDAs are acceptable:");
  console.log("  âœ… Global protocol state (not user funds)");
  console.log("  âœ… With explicit per-user accounting inside shared account");
  console.log("  âœ… Read-only data structures");
  console.log("");

  console.log("  Prevention:");
  console.log("  âœ… Include user pubkey in PDA seeds");
  console.log("  âœ… Pattern: [b\"resource\", user.key()]");
  console.log("  âœ… Isolate user funds to user-specific PDAs");
  console.log("  âœ… If using shared PDA, maintain per-user balance mapping");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

demonstrateExploit().catch((err) => {
  console.error("Error:", err);
  process.exit(1);
});
