/**
 * Standalone Exploit Demonstration: Reinitialization Attacks
 *
 * This script demonstrates how missing initialization guards
 * allow attackers to reinitialize victim accounts.
 */

import { Keypair, PublicKey } from "@solana/web3.js";

async function demonstrateExploit() {
  console.log("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  EXPLOIT: Reinitialization Attacks");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

  const alice = Keypair.generate();
  const attacker = Keypair.generate();
  const programId = Keypair.generate().publicKey;

  // Derive Alice's vault PDA
  const aliceVaultSeeds = Buffer.concat([
    Buffer.from("vault"),
    alice.publicKey.toBuffer(),
  ]);
  const aliceVaultPda = PublicKey.createProgramAddressSync(
    [aliceVaultSeeds, Buffer.from([255])],
    programId
  );

  console.log("ðŸ“‹ Initial Setup:");
  console.log("   Alice:       ", alice.publicKey.toBase58());
  console.log("   Attacker:    ", attacker.publicKey.toBase58());
  console.log("   Program ID:  ", programId.toBase58());
  console.log("   Alice's PDA: ", aliceVaultPda.toBase58());
  console.log("");

  console.log("Step 1: Alice initializes her vault");
  console.log("   PDA derivation: [b\"vault\", alice.pubkey]");
  console.log("   Authority: Alice");
  console.log("   Balance: 0 SOL");
  console.log("   âœ… Vault initialized");
  console.log("");

  console.log("Step 2: Alice deposits funds");
  console.log("   Deposit: 100 SOL");
  console.log("   Vault balance: 100 SOL");
  console.log("   âœ… Funds deposited");
  console.log("");

  console.log("Step 3: ðŸš¨ ATTACK - Attacker reinitializes vault");
  console.log("   Key insight: PDAs are DETERMINISTIC!");
  console.log("");
  console.log("   Attacker can derive Alice's vault PDA:");
  console.log("   seeds = [b\"vault\", alice_pubkey]");
  console.log("   Alice's vault PDA = " + aliceVaultPda.toBase58());
  console.log("");
  console.log("   Attack execution:");
  console.log("   1. Derive Alice's vault address (public info!)");
  console.log("   2. Call initialize() on Alice's vault");
  console.log("   3. Pass attacker as new authority");
  console.log("   4. Vault authority overwritten!");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  VULNERABLE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âš ï¸  EXPLOIT SUCCESSFUL!");
  console.log("");
  console.log("   Before reinitialization:");
  console.log("   Authority: Alice");
  console.log("   Balance:   100 SOL");
  console.log("");
  console.log("   After reinitialization:");
  console.log("   Authority: Attacker â† CHANGED!");
  console.log("   Balance:   0 SOL     â† RESET!");
  console.log("");
  console.log("   ðŸ’€ Reinitialization succeeded");
  console.log("   ðŸ’€ Authority overwritten to Attacker");
  console.log("   ðŸ’€ Alice's 100 SOL potentially lost!");
  console.log("   ðŸ’€ Attacker now controls the vault");
  console.log("");

  console.log("   Why it worked:");
  console.log("   âŒ No is_initialized flag check");
  console.log("   âŒ Initialize function can be called multiple times");
  console.log("   âŒ State overwrites existing data");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  SECURE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âœ… ATTACK BLOCKED!");
  console.log("");
  console.log("   Vault state:");
  console.log("   Authority: Alice [UNCHANGED]");
  console.log("   Balance:   100 SOL [UNCHANGED]");
  console.log("");
  console.log("   âœ… Transaction rejected");
  console.log("   âœ… Error: AccountAlreadyInitialized");
  console.log("   âœ… Alice's funds safe");
  console.log("");

  console.log("   How it was fixed:");
  console.log("   âœ… Anchor's #[account(init)] constraint");
  console.log("   âœ… Manual is_initialized flag check");
  console.log("   âœ… Rejects already-initialized accounts");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  IMPACT SUMMARY");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("  Severity: ðŸŸ  HIGH");
  console.log("  Frequency: Moderate");
  console.log("");
  console.log("  Consequences:");
  console.log("  â€¢ Account takeover");
  console.log("  â€¢ Authority hijacking");
  console.log("  â€¢ Potential fund loss");
  console.log("");

  console.log("  How attackers find victims:");
  console.log("  1. Scan blockchain for initialized vaults");
  console.log("  2. For each vault, derive PDA to find owner");
  console.log("  3. Call initialize on victim's PDA");
  console.log("  4. Steal control of account");
  console.log("");

  console.log("  Prevention:");
  console.log("  âœ… Use #[account(init)] in Anchor");
  console.log("  âœ… Add is_initialized flag and validate it");
  console.log("  âœ… Check is_initialized = false before init");
  console.log("  âœ… Set is_initialized = true after init");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

demonstrateExploit().catch((err) => {
  console.error("Error:", err);
  process.exit(1);
});
