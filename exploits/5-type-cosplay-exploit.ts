/**
 * Standalone Exploit Demonstration: Type Cosplay
 *
 * This script demonstrates the $52M Cashio vulnerability where
 * missing discriminator checks allow type confusion attacks.
 */

import { Keypair, PublicKey } from "@solana/web3.js";

async function demonstrateExploit() {
  console.log("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  EXPLOIT: Type Cosplay ($52M Cashio)");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

  const attacker = Keypair.generate();
  const adminPubkey = Keypair.generate().publicKey;
  const userAccount = Keypair.generate().publicKey;

  console.log("ğŸ“‹ Initial Setup:");
  console.log("   Attacker:     ", attacker.publicKey.toBase58());
  console.log("   Admin:        ", adminPubkey.toBase58());
  console.log("   User Account: ", userAccount.toBase58());
  console.log("");

  console.log("Step 1: Understanding account types");
  console.log("");
  console.log("   UserAccount structure:");
  console.log("   [discriminator: 8 bytes] [owner: 32 bytes] [balance: 8 bytes]");
  console.log("");
  console.log("   AdminAccount structure:");
  console.log("   [discriminator: 8 bytes] [owner: 32 bytes] [privileges: 8 bytes]");
  console.log("");
  console.log("   Same memory layout, different discriminators!");
  console.log("");

  console.log("Step 2: Attacker creates UserAccount");
  console.log("   Discriminator: USER_ACCOUNT (0xABCD...)");
  console.log("   Owner: Attacker");
  console.log("   Balance: 1000");
  console.log("   âœ… User account created");
  console.log("");

  console.log("Step 3: ğŸš¨ ATTACK - Type Cosplay");
  console.log("   Vulnerability: Program deserializes without discriminator check");
  console.log("");
  console.log("   Attack execution:");
  console.log("   1. Call admin-only function (e.g., mint_tokens)");
  console.log("   2. Pass UserAccount where AdminAccount expected");
  console.log("   3. Program deserializes as AdminAccount");
  console.log("   4. No discriminator validation!");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  VULNERABLE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âš ï¸  EXPLOIT SUCCESSFUL!");
  console.log("");
  console.log("   Account passed: UserAccount");
  console.log("   Account interpreted as: AdminAccount");
  console.log("");
  console.log("   Memory interpretation:");
  console.log("   Bytes 0-7:   Discriminator (WRONG TYPE, but not checked!)");
  console.log("   Bytes 8-39:  Owner (Attacker)");
  console.log("   Bytes 40-47: balance=1000 interpreted as privileges=1000");
  console.log("");
  console.log("   ğŸ’€ Type confusion succeeded");
  console.log("   ğŸ’€ UserAccount accepted as AdminAccount");
  console.log("   ğŸ’€ Attacker gains admin privileges!");
  console.log("");

  console.log("   Real-world impact (Cashio, March 2022):");
  console.log("   â€¢ Attacker created fake \"Mint\" account");
  console.log("   â€¢ supply field set to 0 (controlled value)");
  console.log("   â€¢ Protocol: collateral_value / supply");
  console.log("   â€¢ Result: division by zero = INFINITE collateral");
  console.log("   â€¢ Minted unlimited stablecoins");
  console.log("   â€¢ Drained $52,000,000 from protocol");
  console.log("");

  console.log("   Why it worked:");
  console.log("   âŒ Program uses AccountInfo instead of Account<'info, T>");
  console.log("   âŒ Manual deserialization without discriminator check");
  console.log("   âŒ Same memory layout enables type confusion");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  SECURE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âœ… ATTACK BLOCKED!");
  console.log("");
  console.log("   âœ… Transaction rejected");
  console.log("   âœ… Error: InvalidAccountData (discriminator mismatch)");
  console.log("   âœ… Type confusion prevented");
  console.log("");

  console.log("   How it was fixed:");
  console.log("   âœ… Use Account<'info, AdminAccount> type");
  console.log("   âœ… Anchor automatically validates discriminator");
  console.log("   âœ… Manual check in Pinocchio: data[0..8] == EXPECTED");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  IMPACT SUMMARY");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("  Severity: ğŸ”´ CRITICAL");
  console.log("  Frequency: Common");
  console.log("  Real Loss: $52,000,000 (Cashio)");
  console.log("");
  console.log("  Consequences:");
  console.log("  â€¢ Privilege escalation");
  console.log("  â€¢ Unauthorized admin actions");
  console.log("  â€¢ Protocol logic bypass");
  console.log("  â€¢ Massive fund theft (historical precedent)");
  console.log("");

  console.log("  Discriminator calculation:");
  console.log("  discriminator = SHA256(\"account:<AccountName>\")[0..8]");
  console.log("");
  console.log("  Prevention:");
  console.log("  âœ… ALWAYS use Account<'info, T> (not AccountInfo)");
  console.log("  âœ… Anchor handles discriminator validation automatically");
  console.log("  âœ… In Pinocchio: MUST manually check discriminator");
  console.log("  âœ… Never deserialize without type validation");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

demonstrateExploit().catch((err) => {
  console.error("Error:", err);
  process.exit(1);
});
