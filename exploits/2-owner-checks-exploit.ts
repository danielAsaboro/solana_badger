/**
 * Standalone Exploit Demonstration: Missing Owner Checks
 *
 * This script demonstrates how missing owner validation allows
 * attackers to pass fake accounts from malicious programs.
 */

import { Keypair, PublicKey } from "@solana/web3.js";

async function demonstrateExploit() {
  console.log("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  EXPLOIT: Missing Owner Checks");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

  const attacker = Keypair.generate();
  const realProgramId = Keypair.generate().publicKey;
  const maliciousProgramId = Keypair.generate().publicKey;
  const fakeAccount = Keypair.generate().publicKey;

  console.log("ğŸ“‹ Initial Setup:");
  console.log("   Real Program:      ", realProgramId.toBase58());
  console.log("   Malicious Program: ", maliciousProgramId.toBase58());
  console.log("   Fake Account:      ", fakeAccount.toBase58());
  console.log("");

  console.log("Step 1: Attacker deploys malicious program");
  console.log("   Malicious program mimics real program's data structure");
  console.log("   âœ… Malicious program deployed");
  console.log("");

  console.log("Step 2: Attacker creates fake account");
  console.log("   Owner: Malicious Program (not Real Program!)");
  console.log("   Data structure: Same layout as real account");
  console.log("   Balance field: 1,000,000 (fake inflated value!)");
  console.log("   âœ… Fake account created");
  console.log("");

  console.log("Step 3: ğŸš¨ ATTACK - Pass fake account to real program");
  console.log("   Vulnerability: Program uses AccountInfo without owner check");
  console.log("");
  console.log("   Attack execution:");
  console.log("   1. Call real program's withdraw function");
  console.log("   2. Pass fake account owned by malicious program");
  console.log("   3. Program deserializes fake account data");
  console.log("   4. Program reads fake balance: 1,000,000");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  VULNERABLE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âš ï¸  EXPLOIT SUCCESSFUL!");
  console.log("");
  console.log("   Account Details:");
  console.log("   Owner: " + maliciousProgramId.toBase58().slice(0, 16) + "... (MALICIOUS!)");
  console.log("   Balance: 1,000,000 (FAKE!)");
  console.log("");
  console.log("   ğŸ’€ Fake account accepted by real program");
  console.log("   ğŸ’€ Withdrawal based on fake balance succeeds");
  console.log("   ğŸ’€ Attacker steals real funds using fake data!");
  console.log("");

  console.log("   Why it worked:");
  console.log("   âŒ Program uses pub account: AccountInfo");
  console.log("   âŒ No account.owner validation");
  console.log("   âŒ Deserializes data without ownership check");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  SECURE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âœ… ATTACK BLOCKED!");
  console.log("");
  console.log("   âœ… Transaction rejected");
  console.log("   âœ… Error: InvalidAccountOwner");
  console.log("   âœ… Fake account detected and rejected");
  console.log("");

  console.log("   How it was fixed:");
  console.log("   âœ… Program uses pub account: Account<'info, MyType>");
  console.log("   âœ… Anchor automatically validates owner == program_id");
  console.log("   âœ… Fake accounts from other programs rejected");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  IMPACT SUMMARY");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("  Severity: ğŸ”´ CRITICAL");
  console.log("  Frequency: Very Common (35% of vulnerabilities)");
  console.log("");
  console.log("  Consequences:");
  console.log("  â€¢ Protocol logic bypass");
  console.log("  â€¢ Fund theft via fake account data");
  console.log("  â€¢ Privilege escalation");
  console.log("");

  console.log("  Prevention:");
  console.log("  âœ… Use Account<'info, T> instead of AccountInfo");
  console.log("  âœ… Anchor automatically validates owner field");
  console.log("  âœ… In Pinocchio: manually check account.owner == program_id");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

demonstrateExploit().catch((err) => {
  console.error("Error:", err);
  process.exit(1);
});
