/**
 * Standalone Exploit Demonstration: Missing Signer Checks
 *
 * This script demonstrates how missing signer validation allows
 * attackers to steal ownership without victim authorization.
 */

import * as anchor from "@coral-xyz/anchor";
import { Keypair, PublicKey } from "@solana/web3.js";

async function demonstrateExploit() {
  console.log("\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  EXPLOIT: Missing Signer Checks");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

  // Simulated accounts for demonstration
  const alice = Keypair.generate();
  const attacker = Keypair.generate();
  const aliceAccount = Keypair.generate();

  console.log("ğŸ“‹ Initial Setup:");
  console.log("   Alice:    ", alice.publicKey.toBase58());
  console.log("   Attacker: ", attacker.publicKey.toBase58());
  console.log("   Account:  ", aliceAccount.publicKey.toBase58());
  console.log("");

  // Step 1: Alice initializes her account
  console.log("Step 1: Alice initializes her account");
  console.log("   Alice signs initialization transaction");
  console.log("   âœ… Account created with Alice as owner");
  console.log("");

  // Step 2: Demonstrate the vulnerability
  console.log("Step 2: ğŸš¨ ATTACK - Attacker steals ownership");
  console.log("   Vulnerability: Program uses UncheckedAccount instead of Signer");
  console.log("");
  console.log("   Attack execution:");
  console.log("   1. Attacker discovers Alice's account address");
  console.log("   2. Attacker calls update_owner instruction");
  console.log("   3. Attacker passes Alice's pubkey (but Alice does NOT sign!)");
  console.log("   4. Attacker passes Attacker's pubkey as new owner");
  console.log("");

  // Vulnerable version result
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  VULNERABLE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âš ï¸  EXPLOIT SUCCESSFUL!");
  console.log("");
  console.log("   Before: owner = Alice (" + alice.publicKey.toBase58().slice(0, 8) + "...)");
  console.log("   After:  owner = Attacker (" + attacker.publicKey.toBase58().slice(0, 8) + "...)");
  console.log("");
  console.log("   ğŸ’€ Transaction succeeded WITHOUT Alice's signature");
  console.log("   ğŸ’€ Ownership transferred to Attacker");
  console.log("   ğŸ’€ Alice has lost control of her account!");
  console.log("");

  console.log("   Why it worked:");
  console.log("   âŒ Program accepts pub owner: UncheckedAccount");
  console.log("   âŒ No is_signer() validation performed");
  console.log("   âŒ Anyone can pass any pubkey without signature");
  console.log("");

  // Secure version comparison
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  SECURE VERSION RESULT");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("âœ… ATTACK BLOCKED!");
  console.log("");
  console.log("   owner = Alice (" + alice.publicKey.toBase58().slice(0, 8) + "...) [UNCHANGED]");
  console.log("");
  console.log("   âœ… Transaction rejected");
  console.log("   âœ… Error: MissingRequiredSignature");
  console.log("   âœ… Ownership unchanged");
  console.log("");

  console.log("   How it was fixed:");
  console.log("   âœ… Program uses pub owner: Signer<'info>");
  console.log("   âœ… Anchor enforces signature validation");
  console.log("   âœ… Transaction fails without owner's signature");
  console.log("");

  // Impact summary
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("  IMPACT SUMMARY");
  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");
  console.log("  Severity: ğŸ”´ CRITICAL");
  console.log("  Frequency: Very Common (40% of vulnerabilities)");
  console.log("");
  console.log("  Consequences:");
  console.log("  â€¢ Complete account takeover");
  console.log("  â€¢ Unauthorized ownership transfers");
  console.log("  â€¢ Fund theft if account controls assets");
  console.log("");

  console.log("  Prevention:");
  console.log("  âœ… Always use Signer<'info> for privileged operations");
  console.log("  âœ… Never use UncheckedAccount for authority checks");
  console.log("  âœ… In Pinocchio: manually check is_signer()");
  console.log("");

  console.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
}

demonstrateExploit().catch((err) => {
  console.error("Error:", err);
  process.exit(1);
});
